name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Windows
            os: windows-latest
            arch: amd64
            ext: .exe
            build-args: -platform windows/amd64

          - name: macOS Intel
            os: macos-latest
            arch: amd64
            ext: ''
            build-args: -platform darwin/amd64

          - name: macOS Apple Silicon
            os: macos-latest
            arch: arm64
            ext: ''
            build-args: -platform darwin/arm64

          - name: Linux
            os: ubuntu-latest
            arch: amd64
            ext: ''
            build-args: -platform linux/amd64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev
          if ! sudo apt-get install -y libwebkit2gtk-4.0-dev; then
            sudo apt-get install -y libwebkit2gtk-4.1-dev
          fi

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build application
        run: |
          wails build ${{ matrix.build-args }} -clean

      - name: Create release artifact (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd build/bin
          $version = "${{ github.ref_name }}"
          $filename = "yuque-spider-gui-${version}-windows-amd64.zip"
          Compress-Archive -Path yuque-spider-gui.exe -DestinationPath $filename
          echo "ARTIFACT_PATH=build/bin/$filename" >> $env:GITHUB_ENV
          echo "ARTIFACT_NAME=$filename" >> $env:GITHUB_ENV

      - name: Create release artifact (macOS/Linux)
        if: matrix.os != 'windows-latest'
        run: |
          cd build/bin
          version="${{ github.ref_name }}"
          if [ "${{ matrix.os }}" == "macos-latest" ]; then
            if [ "${{ matrix.arch }}" == "arm64" ]; then
              filename="yuque-spider-gui-${version}-darwin-arm64.tar.gz"
            else
              filename="yuque-spider-gui-${version}-darwin-amd64.tar.gz"
            fi
          else
            filename="yuque-spider-gui-${version}-linux-amd64.tar.gz"
          fi

          if [ -f "yuque-spider-gui.app" ]; then
            tar -czf $filename yuque-spider-gui.app
          elif [ -d "yuque-spider-gui.app" ]; then
            tar -czf $filename yuque-spider-gui.app
          else
            tar -czf $filename yuque-spider-gui
          fi

          echo "ARTIFACT_PATH=build/bin/$filename" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=$filename" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_PATH }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*
          generate_release_notes: true
          body: |
            ## è¯­é›€çŸ¥è¯†åº“ä¸‹è½½å™¨ ${{ github.ref_name }}

            ### åŠŸèƒ½ç‰¹æ€§
            - âœ¨ æ”¯æŒä¸‹è½½ä»»æ„è¯­é›€çŸ¥è¯†åº“ä¸º Markdown æ ¼å¼
            - ğŸ–¼ï¸ è‡ªåŠ¨ä¸‹è½½å¹¶æœ¬åœ°åŒ–æ‰€æœ‰å›¾ç‰‡èµ„æº
            - ğŸ” æ”¯æŒä½¿ç”¨ Cookie è®¿é—®ç§æœ‰çŸ¥è¯†åº“
            - âš™ï¸ å¯é…ç½®ä¸‹è½½å»¶è¿Ÿã€è¶…æ—¶ç­‰å‚æ•°
            - ğŸ“Š å®æ—¶æ˜¾ç¤ºä¸‹è½½è¿›åº¦
            - ğŸ¨ ç°ä»£åŒ–å›¾å½¢ç•Œé¢,æ˜“äºä½¿ç”¨

            ### ä¸‹è½½è¯´æ˜
            - **Windows**: ä¸‹è½½ `windows-amd64.zip` å¹¶è§£å‹è¿è¡Œ
            - **macOS Intel**: ä¸‹è½½ `darwin-amd64.tar.gz`
            - **macOS Apple Silicon**: ä¸‹è½½ `darwin-arm64.tar.gz`
            - **Linux**: ä¸‹è½½ `linux-amd64.tar.gz`

            ### ä½œè€…
            Developed with â¤ï¸ by **Spritualkb**

            åŸºäº [yuque-crawl](https://github.com/burpheart/yuque-crawl) é¡¹ç›®æ”¹è¿›
            ä½¿ç”¨ [Wails](https://wails.io) æ„å»º
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
